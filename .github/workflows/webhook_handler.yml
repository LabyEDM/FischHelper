name: FischPedia Webhook Handler

on:
  repository_dispatch:
    types: [add-fish]
  workflow_dispatch:
    inputs:
      fishName:
        description: 'Fish Name'
        required: true
      rarity:
        description: 'Rarity'
        required: true
      location:
        description: 'Location'
        required: true
      value:
        description: 'Base Value'
        required: true
      powerRequired:
        description: 'Power Required'
        required: true
      speed:
        description: 'Speed'
        required: true
      controlNeeded:
        description: 'Control Needed'
        required: true
      notes:
        description: 'Notes (optional)'
        required: false
      bestTime:
        description: 'Best Time (optional)'
        required: false

jobs:
  add-fish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get fish data
        id: fish-data
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            FISH_NAME="${{ github.event.client_payload.fishName }}"
            RARITY="${{ github.event.client_payload.rarity }}"
            LOCATION="${{ github.event.client_payload.location }}"
            VALUE="${{ github.event.client_payload.value }}"
            POWER="${{ github.event.client_payload.powerRequired }}"
            SPEED="${{ github.event.client_payload.speed }}"
            CONTROL="${{ github.event.client_payload.controlNeeded }}"
            NOTES="${{ github.event.client_payload.notes }}"
            BEST_TIME="${{ github.event.client_payload.bestTime }}"
          else
            FISH_NAME="${{ github.event.inputs.fishName }}"
            RARITY="${{ github.event.inputs.rarity }}"
            LOCATION="${{ github.event.inputs.location }}"
            VALUE="${{ github.event.inputs.value }}"
            POWER="${{ github.event.inputs.powerRequired }}"
            SPEED="${{ github.event.inputs.speed }}"
            CONTROL="${{ github.event.inputs.controlNeeded }}"
            NOTES="${{ github.event.inputs.notes }}"
            BEST_TIME="${{ github.event.inputs.bestTime }}"
          fi
          
          echo "fish_entry=${FISH_NAME}|${RARITY}|${LOCATION}|${VALUE}|${POWER}|${SPEED}|${CONTROL}|${NOTES}|${BEST_TIME}" >> $GITHUB_OUTPUT
          echo "fish_name=${FISH_NAME}" >> $GITHUB_OUTPUT
      
      - name: Read existing fish data
        id: existing-data
        run: |
          if [ -f "data/fishdata.json" ]; then
            CONTENT=$(cat data/fishdata.json)
            echo "content<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=" >> $GITHUB_OUTPUT
          fi
      
      - name: Update fish data
        run: |
          FISH_NAME="${{ steps.fish-data.outputs.fish_name }}"
          NEW_ENTRY="${{ steps.fish-data.outputs.fish_entry }}"
          EXISTING="${{ steps.existing-data.outputs.content }}"
          
          # Remove old entry if exists
          if echo "$EXISTING" | grep -q "^${FISH_NAME}|"; then
            UPDATED=$(echo "$EXISTING" | grep -v "^${FISH_NAME}|")
          else
            UPDATED="$EXISTING"
          fi
          
          # Add new entry
          if [ -n "$UPDATED" ] && [ "${UPDATED: -1}" != "\n" ]; then
            UPDATED="${UPDATED}\n"
          fi
          UPDATED="${UPDATED}${NEW_ENTRY}\n"
          
          echo -e "$UPDATED" > data/fishdata.json
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/fishdata.json
          git commit -m "Add fish: ${{ steps.fish-data.outputs.fish_name }}"
          git push

