name: Process Database Entry Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  process-entry:
    # Only run if issue title starts with "Add" or "Edit" followed by a category
    if: |
      startsWith(github.event.issue.title, 'Add ') || 
      startsWith(github.event.issue.title, 'Edit ')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Extract entry data from issue
        id: extract-data
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Write issue body to a file to avoid shell interpretation issues
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          
          # Extract JSON from code block
          JSON_START=$(grep -n "```json" /tmp/issue_body.txt | cut -d: -f1)
          JSON_END=$(grep -n "```" /tmp/issue_body.txt | tail -n 1 | cut -d: -f1)
          
          if [ -z "$JSON_START" ] || [ -z "$JSON_END" ] || [ "$JSON_START" == "$JSON_END" ]; then
            # Try without json tag
            JSON_START=$(grep -n "^```" /tmp/issue_body.txt | head -n 1 | cut -d: -f1)
            JSON_END=$(grep -n "^```" /tmp/issue_body.txt | tail -n 1 | cut -d: -f1)
          fi
          
          if [ -n "$JSON_START" ] && [ -n "$JSON_END" ] && [ "$JSON_START" != "$JSON_END" ]; then
            # Extract JSON content
            sed -n "$((JSON_START+1)),$((JSON_END-1))p" /tmp/issue_body.txt > /tmp/entry.json
          else
            echo "❌ Could not find JSON code block in issue body"
            echo "Issue body preview:"
            head -n 30 /tmp/issue_body.txt
            exit 1
          fi
          
          # Validate JSON and extract category and name
          if ! node -e "const data = require('/tmp/entry.json'); console.log(data.category); console.log(data.name);" 2>/dev/null; then
            echo "❌ Invalid JSON in issue body"
            cat /tmp/entry.json
            exit 1
          fi
          
          CATEGORY=$(node -e "const data = require('/tmp/entry.json'); console.log(data.category);")
          ENTRY_NAME=$(node -e "const data = require('/tmp/entry.json'); console.log(data.name);")
          ACTION=$(echo "${{ github.event.issue.title }}" | cut -d' ' -f1 | tr '[:upper:]' '[:lower:]')
          
          if [ -z "$CATEGORY" ] || [ -z "$ENTRY_NAME" ]; then
            echo "❌ Missing category or name in entry data"
            cat /tmp/entry.json
            exit 1
          fi
          
          echo "✅ Extracted entry data"
          echo "✅ Category: $CATEGORY"
          echo "✅ Entry name: $ENTRY_NAME"
          echo "✅ Action: $ACTION"
          
          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
          echo "entry_name=${ENTRY_NAME}" >> $GITHUB_OUTPUT
          echo "action=${ACTION}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Pull latest changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --rebase origin main || git pull origin main
      
      - name: Read and update database
        id: update-database
        env:
          CATEGORY: ${{ steps.extract-data.outputs.category }}
          ENTRY_NAME: ${{ steps.extract-data.outputs.entry_name }}
          ACTION: ${{ steps.extract-data.outputs.action }}
        run: |
          # Initialize database structure if file doesn't exist
          if [ ! -f "data/fishdata.json" ]; then
            node -e "const fs = require('fs'); fs.writeFileSync('data/fishdata.json', JSON.stringify({fish:[],rods:[],baits:[],mutations:[],potions:[],utility:[],weather:[],season:[],enchanting:[],events:[],locations:[],'admin-events':[],'totem-events':[],'mini-events':[],attributes:[]}, null, 2) + '\n');"
          fi
          
          # Read existing database
          node << NODE_SCRIPT
          const fs = require('fs');
          const path = require('path');
          
          const dbPath = path.join(process.cwd(), 'data/fishdata.json');
          const entryPath = '/tmp/entry.json';
          const category = process.env.CATEGORY || 'fish';
          
          let database = {};
          try {
            const dbContent = fs.readFileSync(dbPath, 'utf8');
            // Try to parse as JSON
            try {
              database = JSON.parse(dbContent);
            } catch (e) {
              // If not JSON, try to parse as old pipe format (fish only)
              const lines = dbContent.split('\n');
              database = {
                fish: [],
                rods: [],
                baits: [],
                mutations: [],
                potions: [],
                utility: [],
                weather: [],
                season: [],
                enchanting: [],
                events: [],
                locations: [],
                'admin-events': [],
                'totem-events': [],
                'mini-events': []
              };
              
              for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('//')) continue;
                const parts = trimmed.split('|');
                if (parts.length >= 6) {
                  database.fish.push({
                    name: parts[0]?.trim() || '',
                    rarity: parts[1]?.trim() || '',
                    location: parts[2]?.trim() || '',
                    value: parts[3]?.trim() || '',
                    powerRequired: parts[4]?.trim() || '',
                    speed: parts[5]?.trim() || '',
                    controlNeeded: parts[6]?.trim() || '',
                    notes: parts[7]?.trim() || '',
                    bestTime: parts[8]?.trim() || '',
                    category: 'fish'
                  });
                }
              }
            }
          } catch (e) {
            // Initialize empty database
            database = {
              fish: [],
              rods: [],
              baits: [],
              mutations: [],
              potions: [],
              utility: [],
              weather: [],
              season: [],
              enchanting: [],
              events: [],
              locations: [],
              'admin-events': [],
              'totem-events': [],
              'mini-events': []
            };
          }
          
          // Ensure all categories exist
          const categories = ['fish', 'rods', 'baits', 'mutations', 'attributes', 'potions', 'utility', 'weather', 'season', 'enchanting', 'events', 'locations', 'admin-events', 'totem-events', 'mini-events'];
          categories.forEach(cat => {
            if (!database[cat]) {
              database[cat] = [];
            }
          });
          
          // Read new entry
          const newEntry = JSON.parse(fs.readFileSync(entryPath, 'utf8'));
          const entryCategory = newEntry.category || category;
          
          if (!database[entryCategory]) {
            database[entryCategory] = [];
          }
          
          // Remove existing entry with same name if editing
          database[entryCategory] = database[entryCategory].filter(entry => entry.name !== newEntry.name);
          
          // Add new entry
          database[entryCategory].push(newEntry);
          
          // Sort by name
          database[entryCategory].sort((a, b) => {
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          
          // Write updated database
          fs.writeFileSync(dbPath, JSON.stringify(database, null, 2) + '\n');
          
          console.log(`✅ Updated ${entryCategory} category`);
          console.log(`✅ ${database[entryCategory].length} entries in ${entryCategory}`);
          NODE_SCRIPT
          
          echo "Database updated successfully"
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add data/fishdata.json
          
          ACTION="${{ steps.extract-data.outputs.action }}"
          CATEGORY="${{ steps.extract-data.outputs.category }}"
          ENTRY_NAME="${{ steps.extract-data.outputs.entry_name }}"
          ISSUE_NUM="${{ steps.extract-data.outputs.issue_number }}"
          
          if [ "$ACTION" == "edit" ]; then
            COMMIT_MSG="${ACTION^} ${CATEGORY}: ${ENTRY_NAME} (from issue #${ISSUE_NUM})"
          else
            COMMIT_MSG="Add ${CATEGORY}: ${ENTRY_NAME} (from issue #${ISSUE_NUM})"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # Retry push with pull if it fails
          for i in 1 2 3; do
            if git push origin HEAD:main; then
              echo "Push successful"
              break
            else
              echo "Push failed, attempt $i. Pulling latest changes..."
              git pull --rebase origin main || git pull origin main
              
              # Re-apply our change
              CATEGORY="${{ steps.extract-data.outputs.category }}"
              env CATEGORY="$CATEGORY" node << NODE_SCRIPT
              const fs = require('fs');
              const path = require('path');
              
              const dbPath = path.join(process.cwd(), 'data/fishdata.json');
              const entryPath = '/tmp/entry.json';
              const category = process.env.CATEGORY || 'fish';
              
              let database = {};
              try {
                const dbContent = fs.readFileSync(dbPath, 'utf8');
                try {
                  database = JSON.parse(dbContent);
                } catch (e) {
                  database = {
                    fish: [], rods: [], baits: [], mutations: [], attributes: [], potions: [],
                    utility: [], weather: [], season: [], enchanting: [], events: [],
                    locations: [], 'admin-events': [], 'totem-events': [], 'mini-events': []
                  };
                }
              } catch (e) {
                database = {
                  fish: [], rods: [], baits: [], mutations: [], potions: [],
                  utility: [], weather: [], season: [], enchanting: [], events: [],
                  locations: [], 'admin-events': [], 'totem-events': [], 'mini-events': []
                };
              }
              
              const categories = ['fish', 'rods', 'baits', 'mutations', 'attributes', 'potions', 'utility', 'weather', 'season', 'enchanting', 'events', 'locations', 'admin-events', 'totem-events', 'mini-events'];
              categories.forEach(cat => {
                if (!database[cat]) database[cat] = [];
              });
              
              const newEntry = JSON.parse(fs.readFileSync(entryPath, 'utf8'));
              const entryCategory = newEntry.category || category;
              
              if (!database[entryCategory]) database[entryCategory] = [];
              database[entryCategory] = database[entryCategory].filter(entry => entry.name !== newEntry.name);
              database[entryCategory].push(newEntry);
              database[entryCategory].sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
              
              fs.writeFileSync(dbPath, JSON.stringify(database, null, 2) + '\n');
              NODE_SCRIPT
              
              git add data/fishdata.json
              git commit -m "$COMMIT_MSG"
            fi
          done
      
      - name: Get commit SHA
        id: get-commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
      
      - name: Comment on issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = '${{ steps.get-commit.outputs.commit_sha }}';
            const repo = context.repo;
            const action = '${{ steps.extract-data.outputs.action }}';
            const category = '${{ steps.extract-data.outputs.category }}';
            const entryName = '${{ steps.extract-data.outputs.entry_name }}';
            
            const actionText = action === 'edit' ? 'updated' : 'added';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: `✅ ${category.charAt(0).toUpperCase() + category.slice(1)} entry ${actionText} successfully! The entry "${entryName}" has been ${actionText} to the database.\n\n` +
                    `View the commit: https://github.com/${repo.owner}/${repo.repo}/commit/${commitSha}`
            });
            
            // Close the issue
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              state: 'closed'
            });
