name: Process Fish Entry Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  process-fish-entry:
    # Only run if issue title starts with "Add Fish:"
    # The web interface automatically sets the title to "Add Fish: [fish name]"
    if: startsWith(github.event.issue.title, 'Add Fish:')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract fish data from issue
        id: extract-data
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Write issue body to a file to avoid shell interpretation issues with special characters
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          
          # Read from file
          ISSUE_BODY_CONTENT=$(cat /tmp/issue_body.txt)
          
          # Extract formatted entry from code block (look for ``` or `)
          FISH_ENTRY=$(echo "$ISSUE_BODY_CONTENT" | grep -A 1 "Formatted Entry:" | tail -n 1 | sed 's/```//g' | sed 's/`//g' | xargs)
          
          # If not found, try to extract from the issue body directly
          if [ -z "$FISH_ENTRY" ] || [ "$FISH_ENTRY" == "" ]; then
            # Try to find pipe-delimited line in the body
            FISH_ENTRY=$(echo "$ISSUE_BODY_CONTENT" | grep -E "^[^|]+\|[^|]+\|" | head -n 1 | xargs)
          fi
          
          if [ -z "$FISH_ENTRY" ] || [ "$FISH_ENTRY" == "" ]; then
            echo "❌ Could not extract fish entry from issue body"
            echo "Issue body preview:"
            echo "$ISSUE_BODY_CONTENT" | head -n 20
            exit 1
          fi
          
          # Extract fish name (first field before |)
          FISH_NAME=$(echo "$FISH_ENTRY" | cut -d'|' -f1 | xargs)
          
          if [ -z "$FISH_NAME" ]; then
            echo "❌ Could not extract fish name from entry: $FISH_ENTRY"
            exit 1
          fi
          
          echo "✅ Extracted fish entry: $FISH_ENTRY"
          echo "✅ Fish name: $FISH_NAME"
          
          echo "fish_entry=${FISH_ENTRY}" >> $GITHUB_OUTPUT
          echo "fish_name=${FISH_NAME}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Pull latest changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin main
      
      - name: Read existing fish data
        id: existing-data
        run: |
          if [ -f "data/fishdata.json" ]; then
            CONTENT=$(cat data/fishdata.json)
            echo "content<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=" >> $GITHUB_OUTPUT
          fi
      
      - name: Update fish data
        run: |
          FISH_NAME="${{ steps.extract-data.outputs.fish_name }}"
          NEW_ENTRY="${{ steps.extract-data.outputs.fish_entry }}"
          EXISTING="${{ steps.existing-data.outputs.content }}"
          
          # Remove old entry if exists
          if echo "$EXISTING" | grep -q "^${FISH_NAME}|"; then
            UPDATED=$(echo "$EXISTING" | grep -v "^${FISH_NAME}|")
            echo "Removed existing entry for ${FISH_NAME}"
          else
            UPDATED="$EXISTING"
          fi
          
          # Add new entry
          if [ -n "$UPDATED" ] && [ "${UPDATED: -1}" != "\n" ]; then
            UPDATED="${UPDATED}\n"
          fi
          UPDATED="${UPDATED}${NEW_ENTRY}\n"
          
          echo -e "$UPDATED" > data/fishdata.json
          echo "Added/updated entry for ${FISH_NAME}"
      
      - name: Commit and push
        run: |
          git add data/fishdata.json
          git commit -m "Add fish: ${{ steps.extract-data.outputs.fish_name }} (from issue #${{ steps.extract-data.outputs.issue_number }})"
          
          # Retry push with pull if it fails
          for i in 1 2 3; do
            if git push origin main; then
              echo "Push successful"
              break
            else
              echo "Push failed, attempt $i. Pulling latest changes..."
              git pull --rebase origin main || git pull origin main
              # Re-apply our change
              FISH_NAME="${{ steps.extract-data.outputs.fish_name }}"
              NEW_ENTRY="${{ steps.extract-data.outputs.fish_entry }}"
              if [ -f "data/fishdata.json" ]; then
                EXISTING=$(cat data/fishdata.json)
              else
                EXISTING=""
              fi
              if echo "$EXISTING" | grep -q "^${FISH_NAME}|"; then
                UPDATED=$(echo "$EXISTING" | grep -v "^${FISH_NAME}|")
              else
                UPDATED="$EXISTING"
              fi
              if [ -n "$UPDATED" ] && [ "${UPDATED: -1}" != "\n" ]; then
                UPDATED="${UPDATED}\n"
              fi
              UPDATED="${UPDATED}${NEW_ENTRY}\n"
              echo -e "$UPDATED" > data/fishdata.json
              git add data/fishdata.json
              git commit -m "Add fish: ${{ steps.extract-data.outputs.fish_name }} (from issue #${{ steps.extract-data.outputs.issue_number }})"
            fi
          done
      
      - name: Get commit SHA
        id: get-commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
      
      - name: Comment on issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = '${{ steps.get-commit.outputs.commit_sha }}';
            const repo = context.repo;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: `✅ Fish entry processed successfully! The fish has been added to the database.\n\n` +
                    `View the commit: https://github.com/${repo.owner}/${repo.repo}/commit/${commitSha}`
            });
            
            // Close the issue
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: repo.owner,
              repo: repo.repo,
              state: 'closed'
            });

